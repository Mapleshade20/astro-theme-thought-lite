---
import { getRelativeLocaleUrl } from "astro:i18n";
import { Icon } from "astro-icon/components";
import config from "$config";
import App from "$layouts/App.astro";
import Navigator from "$layouts/header/Navigator.svelte";
import Footer from "$layouts/Footer.astro";
import "$styles/global.less";
import "$styles/markdown.less";
import "medium-zoom/dist/style.css";

let route = Astro.url.pathname;

const { locale = config.i18n.defaultLocale, title: subtitle, description = config.description, article } = Astro.props;
const title = config.title;
---

<script>
	import zoom from "medium-zoom/dist/pure";
	import Time from "$utils/time";

	// Set the `title` attribute of all `<time>` elements to localized date-time strings
	const localizeTimes = () => document.querySelectorAll("time").forEach(time => time.dateTime && (time.title = Time.locale(time.dateTime, navigator.language, Time.userTimezone)));

	// Add zoom effect to images within markdown content
	window.zoom = () => zoom(".markdown img:not([data-nozoom])", { background: "#00000044" });

	function handleHash() {
		const hash = window.location.hash;
		if (!hash) return;

		const id = hash.substring(1);
		const target = document.getElementById(decodeURIComponent(id));

		if (target) {
			target.scrollIntoView({ block: "center", behavior: "smooth" });

			if (id.includes("fnref") || id.includes("ref")) {
				target.classList.add("highlight-target");
				setTimeout(() => target.classList.remove("highlight-target"), 1000);
			}
		}
	}

	// Page initialization function
	function initialize() {
		localizeTimes();
		window.zoom();
		if (window.location.hash) {
			setTimeout(handleHash, 300);
		}
	}

	// Execute initialization on first load
	initialize();

	// Listen for page load event and re-initialize on page transitions
	document.addEventListener("astro:page-load", initialize);

	window.addEventListener("hashchange", handleHash);

	document.addEventListener("click", (e) => {
		const target = e.target;
		if (!(target instanceof Element)) return;
		const anchor = target.closest("a");
		if (!anchor) return;

		const href = anchor.getAttribute("href");
		if (href && href.startsWith("#")) {
			e.preventDefault();
			history.pushState(null, "", href);
			handleHash();
		}
	});
</script>

<App {title} {subtitle} {description} {article} author={config.author.name}>
	<slot name="head" slot="head" />
	<header class="sticky top-0 z-40 mb-4 w-full">
		<div class="absolute inset-0 backdrop-filter backdrop-blur -z-1 bg-[color-mix(in_srgb,var(--background-color)_70%,transparent)]"></div>
		<div class="mx-a px-4 w-[min(100%,1000px)]">
			<div class="relative flex items-center justify-between py-2.25">
				<a href={getRelativeLocaleUrl(locale)} class="flex items-center gap-2 text-size-lg c-strong">
					<img src="/avatar.webp" alt="" class="w-13 rounded-full opacity-80" />
					{title}
				</a>

				<Navigator {locale} {route} showLibrary={config.library?.showInNavigation} client:load>
					<Icon name="lucide:tent" slot="home" is:inline />
					<Icon name="lucide:list" slot="note" is:inline />
					<Icon name="lucide:feather" slot="jotting" is:inline />
					<Icon name="lucide:book-open" slot="library" is:inline />
					<Icon name="lucide:at-sign" slot="about" is:inline />
					<Icon name="lucide:earth" slot="globe" is:inline />
					<Icon name="lucide:rss" slot="rss" is:inline />
					<Icon name="lucide:sun" slot="sun" is:inline />
					<Icon name="lucide:moon" slot="moon" is:inline />
					<Icon name="lucide:align-justify" slot="bars" is:inline />
					<Icon name="lucide:x" slot="close" is:inline />
				</Navigator>
			</div>
		</div>
	</header>
	<div class="flex flex-col mx-a px-6 pt-3 w-[min(100%,1000px)] min-h-screen">
		<div id="body" class="flex flex-col flex-grow">
			<slot />
		</div>

		<Footer {locale} author={config.author} copyright={config.copyright} />
	</div>
</App>
