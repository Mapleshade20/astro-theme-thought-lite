---
import { render, getCollection } from "astro:content";
import { getRelativeLocaleUrl } from "astro:i18n";
import { Icon } from "astro-icon/components";
import config, { monolocale } from "$config";
import Time from "$utils/time";
import Base from "$layouts/Base.astro";
import Heatmap from "$components/Heatmap.svelte";
import i18nit from "$i18n";

export async function getStaticPaths() {
	// Create path for each locale, omitting default locale from URL
	return config.i18n.locales.map(locale => ({ params: { locale: config.i18n.defaultLocale === locale ? undefined : locale } }));
}

const { locale = config.i18n.defaultLocale } = Astro.params;

const t = i18nit(locale);

// Get preface content for current locale, sorted by timestamp (latest first)
const prefaces = (
	await getCollection("preface", preface => {
		// Handle single locale setup
		if (monolocale) return true;

		// Extract language and ID from file path structure
		const [language, id] = preface.id.split("/");
		preface.id = id;

		// Filter by current locale
		return language === locale;
	})
).sort((a, b) => b.data.timestamp.getTime() - a.data.timestamp.getTime());

// Get published notes for current locale
const notes = await getCollection("note", note => {
	// Assign type property
	Reflect.set(note, "type", "note");

	// Filter by publication status and locale
	let published = !note.data.draft;
	let localed = monolocale || note.id.split("/")[0] === locale;

	// Filter published notes by current locale
	return published && localed;
});

// Get published jottings for current locale
const jottings = await getCollection("jotting", jotting => {
	// Assign type property
	Reflect.set(jotting, "type", "jotting");

	// Check monolocale setup or extract language to match locale
	let localed = monolocale || jotting.id.split("/")[0] === locale;

	// Filter published notes by current locale
	return !jotting.data.draft && localed;
});

// Combine contents
let items: { id: string; type?: string; data: { timestamp: Date; tags?: string[]; [key: string]: any } }[] = [];

// Determine which sections to include
const sections = config.latest || "*";

// Add contents based on config
if (sections === "*" || sections.includes("note")) items = items.concat(notes);
if (sections === "*" || sections.includes("jotting")) items = items.concat(jottings);

// Get the latest content for display
const latest = items.sort((a, b) => b.data.timestamp.getTime() - a.data.timestamp.getTime())[0];

// Get the latest preface for display
// Get knowledge items with status "inProgress" for current locale
const readingBooks = await getCollection("knowledge", item => {
	let localed = monolocale || item.id.split("/")[0] === locale;

	// Filter criteria: must be published, match locale, and be currently reading
	return !item.data.draft && localed && item.data.status === "inProgress";
});

// Get the most recent note and preface for display
const preface = prefaces[0];
// Render preface content if available, otherwise use empty object
const { Content } = preface ? await render(preface) : ({} as any);
---

<Base title={t("navigation.home")} {locale}>
	<Fragment slot="head">
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playwrite+MX:wght@100&display=swap" media="print" onload="this.media='all'" />
	</Fragment>
	<main class="flex flex-col gap-5 sm:gap-20 flex-grow">
		<header class="flex items-center justify-center flex-wrap-reverse grow-0.6">
			{config.prologue && <article class="font-cursive mr-a font-thin text-size-xl sm:text-size-2xl line-height-loose whitespace-pre-line">{config.prologue}</article>}
			<Icon name="site-logo" size={100} is:inline />
		</header>

		{
			preface && (
				<section class="flex flex-col">
					<article class="markdown">
						<Content />
					</article>
					<a href={getRelativeLocaleUrl(locale, "/preface")} class="self-end my-2 text-size-sm c-secondary">
						—— {Time.date.locale(preface.data.timestamp, locale)}
					</a>
				</section>
			)
		}

		{
			latest && (
				<footer class="flex items-center justify-center flex-wrap-reverse gap-10">
					<Heatmap {locale} {notes} {jottings} />

					<blockquote class="flex-grow">
						<h3>{t("home.latest")}</h3>
						<div class="flex flex-col sm:flex-row justify-between gap-1 mt-2">
							<a href={getRelativeLocaleUrl(locale, `/${latest.type}/${monolocale ? latest.id : latest.id.split("/").slice(1).join("/")}`)} class="text-size-lg link">
								{latest.data.series && `${latest.data.series} | `}
								{latest.data.title}
							</a>
							<div class="flex gap-1">
								{latest.data.tags?.map(tag => (
									<a href={`${getRelativeLocaleUrl(locale, `/${latest.type}`)}?tag=${encodeURIComponent(tag)}`} class="c-weak text-size-xs link">
										#{tag}
									</a>
								))}
							</div>
						</div>
						<time datetime={latest.data.timestamp.toISOString()} class="c-weak text-xs">
							{Time.date.locale(latest.data.timestamp, locale)}
						</time>
					</blockquote>

					{config.library?.showAtHome && readingBooks.length > 0 && (
						<section class="w-full flex flex-col sm:flex-row items-start sm:items-center gap-5">
							<h3 class="shrink-0">{t("home.currentlyReading")}</h3>
							<div class="flex-grow flex flex-wrap gap-8">
								{readingBooks.map(book => {
									const progress = book.data.totalPages && book.data.totalPages > 0 ? Math.round((book.data.currentPage / book.data.totalPages) * 100) : 0;
									return (
										<a href={getRelativeLocaleUrl(locale, `/library/${monolocale ? book.id : book.id.split("/").slice(1).join("/")}`)} class="flex items-center gap-3 group">
											<div class="relative w-16 h-16 shrink-0">
												<svg class="w-16 h-16 transform -rotate-90" viewBox="0 0 64 64">
													<circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="4" fill="none" class="c-border opacity-20" />
													<circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="4" fill="none" stroke-dasharray={`${2 * Math.PI * 28}`} stroke-dashoffset={`${2 * Math.PI * 28 * (1 - progress / 100)}`} class="c-primary transition-all" stroke-linecap="round" />
												</svg>
												<div class="absolute inset-0 flex items-center justify-center text-xs c-remark pb-0.3">{progress}%</div>
											</div>
											<div class="flex-grow min-w-0">
												<div class="font-medium line-clamp-1 group-hover:c-primary transition-colors link">{book.data.title}</div>
												{book.data.author && <div class="text-xs c-remark mt-0.5">{book.data.author}</div>}
											</div>
										</a>
									);
								})}
							</div>
						</section>
					)}
				</footer>
			)
		}
	</main>
</Base>

